\"use client\";\n\nimport { useState, useCallback, useEffect } from \"react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/shadcn/tabs";\nimport { Lightbulb } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { PageHeader } from \"@/components/molecules/PageHeader\";\nimport { IdeaTemplateCard } from \"@/components/molecules/IdeaTemplateCard\";\nimport { AiGeneratedIdeasCard } from \"@/components/molecules/AiGeneratedIdeasCard\";\nimport { MyIdeasCard } from \"@/components/molecules/MyIdeasCard\";\nimport { IdeaFormDialog } from \"@/components/molecules/IdeaFormDialog\";\n\ntype IdeaCategory = \"saas\" | \"iaas\" | \"paas\" | \"website\" | \"webapp\" | \"webshop\" | \"other\";\n\ntype IdeaRecord = {\n  id: number;\n  title: string;\n  description: string;\n  category: IdeaCategory;\n  source: \"template\" | \"ai\" | \"manual\";\n  created_at?: string;\n  updated_at?: string;\n};\n\ntype TemplateIdea = { title: string; description: string; category: IdeaCategory };\n\nconst TEMPLATE_IDEAS: TemplateIdea[] = [\n  { title: \"API usage dashboard for dev teams\", description: \"SaaS that tracks API calls, quotas, and costs per project with alerts and simple reports.\", category: \"saas\" },\n  { title: \"Low-code internal tool builder\", description: \"PaaS to build admin panels, forms, and workflows without code, with DB and auth included.\", category: \"paas\" },\n  { title: \"Managed Redis / cache hosting\", description: \"IaaS-style managed Redis with auto-scaling, backups, and a simple control panel.\", category: \"iaas\" },\n  { title: \"Niche affiliate comparison site\", description: \"Website that compares products in one vertical (e.g. project management, CRM) with honest reviews and affiliate links.\", category: \"website\" },\n  { title: \"Micro-SaaS for recurring reports\", description: \"Webapp that connects to Google Analytics, Stripe, or DB and emails scheduled PDF/Excel reports to stakeholders.\", category: \"webapp\" },\n  { title: \"Print-on-demand storefront\", description: \"Webshop for custom merch (T-shirts, mugs) with design upload, fulfillment integration, and basic SEO.\", category: \"webshop\" },\n  { title: \"Waitlist & early-access landing pages\", description: \"SaaS to create landing pages, collect emails, and send launch updates with minimal setup.\", category: \"saas\" },\n  { title: \"Serverless job queue as a service\", description: \"PaaS to enqueue and run background jobs (cron, webhooks) without managing servers.\", category: \"paas\" },\n  { title: \"Static site + form backend\", description: \"Simple hosting for static sites with form submissions, file uploads, and optional serverless functions.\", category: \"paas\" },\n  { title: \"Developer changelog & release notes\", description: \"Webapp for teams to publish product changelogs, release notes, and roadmap with a public page and optional auth.\", category: \"webapp\" },\n  { title: \"Local-first docs / wiki\", description: \"Website or webapp for documentation that works offline and syncs when online, with markdown and search.\", category: \"webapp\" },\n  { title: \"White-label invoicing for agencies\", description: \"SaaS for freelancers and agencies to send branded invoices, track payments, and basic client portal.\", category: \"saas\" },\n  { title: \"Domain & SSL monitoring\", description: \"Webapp that checks domain expiry, SSL validity, and uptime and sends alerts before issues.\", category: \"webapp\" },\n  { title: \"Niche SaaS directory\", description: \"Curated directory website for one niche (e.g. HR tools, design tools) with filters and short reviews.\", category: \"website\" },\n  { title: \"Subscription box e-commerce\", description: \"Webshop platform for subscription boxes: recurring billing, shipping, and basic customer portal.\", category: \"webshop\" },\n];\n\nconst CATEGORY_LABELS: Record<IdeaCategory, string> = {\n  saas: \"SaaS\",\n  iaas: \"IaaS\",\n  paas: \"PaaS\",\n  website: \"Website\",\n  webapp: \"Webapp\",\  webshop: \"Webshop\",\n  other: \"Other\",\n};\n\nexport function IdeasPageContent() {\n  const [myIdeas, setMyIdeas] = useState<IdeaRecord[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [createOpen, setCreateOpen] = useState(false);\n  const [editOpen, setEditOpen] = useState(false);\n  const [formTitle, setFormTitle] = useState(\"\");\n  const [formDescription, setFormDescription] = useState(\"\");\n  const [formCategory, setFormCategory] = useState<IdeaCategory>(\"other\");\n  const [formId, setFormId] = useState<number | undefined>(undefined);\n  const [saveLoading, setSaveLoading] = useState(false);\n\n  const loadIdeas = useCallback(async () => {\n    try {\n      const res = await fetch(\"/api/data/ideas\");\n      if (!res.ok) throw new Error(await res.text());\n      const data = await res.json();\n      setMyIdeas(Array.isArray(data) ? data : []);\n    } catch (e) {\n      toast.error(e instanceof Error ? e.message : \"Failed to load ideas\");\n      setMyIdeas([]);\n    } finally {\n      setLoading(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    loadIdeas();\n  }, [loadIdeas]);\n\n  const openCreate = useCallback(() => {\n    setFormId(undefined);\n    setFormTitle(\"\");\n    setFormDescription(\"\");\n    setFormCategory(\"other\");\n    setCreateOpen(true);\n  }, []);\n\n  const openEdit = useCallback((idea: IdeaRecord) => {\n    setFormId(idea.id);\n    setFormTitle(idea.title);\n    setFormDescription(idea.description);\n    setFormCategory(idea.category);\n    setEditOpen(true);\n  }, []);\n\n  const handleSaveCreate = useCallback(async () => {\n    if (!formTitle.trim()) return;\n    setSaveLoading(true);\n    try {\n      const res = await fetch(\"/api/data/ideas\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          title: formTitle.trim(),\n          description: formDescription.trim(),\n          category: formCategory,\n          source: \"manual\",\n        }),\n      });\n      if (!res.ok) {\n        const err = await res.json().catch(() => ({}));\n        throw new Error(err.error || res.statusText);\n      }\n      await loadIdeas();\n      setCreateOpen(false);\n      setFormTitle(\"\");\n      setFormDescription(\"\");\n      toast.success(\"Idea added\");\n    } catch (e) {\n      toast.error(e instanceof Error ? e.message : \"Failed to save\");\n    } finally {\n      setSaveLoading(false);\n    }\n  }, [formTitle, formDescription, formCategory, loadIdeas]);\n\n  const handleSaveEdit = useCallback(async () => {\n    if (formId === undefined || !formTitle.trim()) return;\n    setSaveLoading(true);\n    try {\n      const res = await fetch(\"/api/data/ideas\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          id: formId,\n          title: formTitle.trim(),\n          description: formDescription.trim(),\n          category: formCategory,\n        }),\n      });\n      if (!res.ok) {\n        const err = await res.json().catch(() => ({}));\n        throw new Error(err.error || res.statusText);\n      }\n      await loadIdeas();\n      setEditOpen(false);\n      setFormId(undefined);\n      toast.success(\"Idea updated\");\n    } catch (e) {\n      toast.error(e instanceof Error ? e.message : \"Failed to save\");\n    } finally {\n      setSaveLoading(false);\n    }\n  }, [formId, formTitle, formDescription, formCategory, loadIdeas]);\n\n  const addToMyIdeas = useCallback(\n    async (item: { title: string; description: string; category: IdeaCategory }, source: \"template\" | \"ai\") => {\n      try {\n        const res = await fetch(\"/api/data/ideas\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            title: item.title,\n            description: item.description,\n            category: item.category,\n            source,\n          }),\n        });\n        if (!res.ok) {\n          const err = await res.json().catch(() => ({}));\n          throw new Error(err.error || res.statusText);\n        }\n        await loadIdeas();\n        toast.success(\"Added to My ideas\");\n      } catch (e) {\n        toast.error(e instanceof Error ? e.message : \"Failed to add\");\n      }\n    },\n    [loadIdeas]\n  );\n\n  const handleDelete = useCallback(\n    async (ideaId: number) => {\n      try {\n        const res = await fetch(`/api/data/ideas/${ideaId}`, { method: \"DELETE\" });\n        if (!res.ok) {\n          const err = await res.json().catch(() => ({}));\n          throw new Error(err.error || res.statusText);\n        }\n        await loadIdeas();\n        setEditOpen(false);\n        setFormId(undefined);\n        toast.success(\"Idea removed\");\n      } catch (e) {\n        toast.error(e instanceof Error ? e.message : \"Failed to delete\");\n      }\n    },\n    [loadIdeas]\n  );\n\n  return (\n    <div className=\"space-y-6\">\n      <PageHeader\n        title=\"Business ideas\"\n        description=\"SaaS, IaaS, PaaS, websites, webapps, webshops â€” templates, AI-generated, or your own.\"\n        icon={<Lightbulb className=\"h-6 w-6\" />}\n      />\n\n      <Tabs defaultValue=\"templates\" className=\"w-full\">\n        <TabsList className=\"grid w-full max-w-md grid-cols-3\">\n          <TabsTrigger value=\"templates\">Templates</TabsTrigger>\n          <TabsTrigger value=\"ai\">AI generated</TabsTrigger>\n          <TabsTrigger value=\"mine\">My ideas</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"templates\" className=\"mt-6\">\n          <IdeaTemplateCard\n            TEMPLATE_IDEAS={TEMPLATE_IDEAS}\n            CATEGORY_LABELS={CATEGORY_LABELS}\n            addToMyIdeas={addToMyIdeas}\n          />\n        </TabsContent>\n\n        <TabsContent value=\"ai\" className=\"mt-6\">\n          <AiGeneratedIdeasCard CATEGORY_LABELS={CATEGORY_LABELS} addToMyIdeas={addToMyIdeas} />\n        </TabsContent>\n\n        <TabsContent value=\"mine\" className=\"mt-6\">\n          <MyIdeasCard\n            myIdeas={myIdeas}\n            loading={loading}\n            openCreate={openCreate}\n            openEdit={openEdit}\n            handleDelete={handleDelete}\n            CATEGORY_LABELS={CATEGORY_LABELS}\n          />\n        </TabsContent>\n      </Tabs>\n\n      <IdeaFormDialog\n        open={createOpen}\n        setOpen={setCreateOpen}\n        title=\"New idea\"\n        description=\"Add a business or product idea. You can change it later.\"\n        formTitle={formTitle}\n        setFormTitle={setFormTitle}\n        formDescription={formDescription}\n        setFormDescription={setFormDescription}\n        formCategory={formCategory}\n        setFormCategory={setFormCategory}\n        handleSave={handleSaveCreate}\n        saveLoading={saveLoading}\n        CATEGORY_LABELS={CATEGORY_LABELS}\n      />\n\n      <IdeaFormDialog\n        open={editOpen}\n        setOpen={setEditOpen}\n        title=\"Edit idea\"\n        description=\"Update title, description, or category.\"\n        formTitle={formTitle}\n        setFormTitle={setFormTitle}\n        formDescription={formDescription}\n        setFormDescription={setFormDescription}\n        formCategory={formCategory}\n        setFormCategory={setFormCategory}\n        handleSave={handleSaveEdit}\n        saveLoading={saveLoading}\n        CATEGORY_LABELS={CATEGORY_LABELS}\n      />\n    </div>\n  );\n}\n